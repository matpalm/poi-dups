
1. sql to dump pois

select p.id as poi_id, pl.name as poi_name, places.id as place_id
from pois p join places on p.place_id=places.id 
join poi_localisations pl on pl.poi_id=p.id

2. sql to dump places

select id,name,full_name from places

-- don't bother with next step
extract exact dups, keeping only one
$ cat pois.tsv | ./exact_dups.rb > pois.uniq.tsv 2> exact_dups.ids
$ wc -l pois.uniq.tsv
196,590
$ wc -l exact_dups.ids
3,944

split into 4 files
$ ./split_based_on_places.rb < pois.tsv

run near duplicate detection (0.6)
cat pois.p0.tsv | ./near_dups.rb > near_dups.p0.out &
cat pois.p1.tsv | ./near_dups.rb > near_dups.p1.out &
cat pois.p2.tsv | ./near_dups.rb > near_dups.p2.out &
cat pois.p3.tsv | ./near_dups.rb > near_dups.p3.out &
wait

(similarity id1 id2)
0.666666666666667	  1 2
0.578947368421053	  1 3
0.657142857142857	  0 1
...
4323 lines (took 28m)

$ cat near_dups.p*.out | ./connected_components.rb > connected_components.out
1.000     420197  420147
1.000     1112845 1112889 1072699 1072704 1112865 1112878
0.869     1037033 1037044 1037047
0.826     1076554 381583  381207
0.619     401746  401702
1.000     399763  1041146

make human readable (result.csv)
$ ./reportify.rb










